# yaml-language-server: $schema=https://goreleaser.com/static/schema-pro.json
# TODO(p0): Test if templating on boolean values is supported

version: 2

project_name: lotus

universal_binaries:
  - id: lotus
    replace: true
    name_template: lotus

builds:
  - id: lotus
    binary: lotus
    builder: prebuilt
    goos:
      - darwin
      - linux
    goarch:
      - amd64
      - arm64
    goamd64:
      - v1
    ignore:
      - goos: linux
        goarch: arm64
    prebuilt:
      path: '{{ .Env.GITHUB_WORKSPACE }}/{{ .Os }}_{{ .Arch }}{{ with .Amd64 }}_{{ . }}{{ end }}/lotus'
    skip: '{{ .Env.PROJECT != "node" }}'
  - id: lotus-miner
    binary: lotus-miner
    builder: prebuilt
    goos:
      - darwin
      - linux
    goarch:
      - amd64
      - arm64
    goamd64:
      - v1
    ignore:
      - goos: linux
        goarch: arm64
    prebuilt:
      path: '{{ .Env.GITHUB_WORKSPACE }}/{{ .Os }}_{{ .Arch }}{{ with .Amd64 }}_{{ . }}{{ end }}/lotus-miner'
    skip: '{{ .Env.PROJECT != "miner" }}'
  - id: lotus-worker
    binary: lotus-worker
    builder: prebuilt
    goos:
      - darwin
      - linux
    goarch:
      - amd64
      - arm64
    goamd64:
      - v1
    ignore:
      - goos: linux
        goarch: arm64
    prebuilt:
      path: '{{ .Env.GITHUB_WORKSPACE }}/{{ .Os }}_{{ .Arch }}{{ with .Amd64 }}_{{ . }}{{ end }}/lotus-worker'
    skip: '{{ .Env.PROJECT != "miner" }}'

archives:
  - id: primary
    format: tar.gz
    wrap_in_directory: true
    name_template: "{{ .ProjectName }}_{{ .Env.VERSION }}_{{ .Os }}_{{ .Arch }}"
    files:
      # this is a dumb but required hack so it doesn't include the default files
      # https://github.com/goreleaser/goreleaser/issues/602
      - _n_o_n_e_*

release:
  github:
    owner: filecoin-project
    name: lotus
  draft: "{{ .Env.IS_DRAFT }}"
  header: "{{ .Env.HEADER }}"
  make_latest: "${{ .Env.IS_LATEST }}"
  name_template: "{{ .Env.VERSION }}"
  prerelease: "${{ .Env.VERSION | strings.hasSuffix '-rc' }}"
  replace_existing_artifacts: true
  # TODO(p0): Test if not replacing existing drafts updates them instead of failing the release
  replace_existing_draft: false
  tag: "{{ .Env.TAG }}"
  target_commitish: "{{ .Env.TARGET_COMMITISH }}"

# TODO(p0): Figure out how to perform partial Homebrew updates
# brews:
#   - repository:
#       owner: filecoin-project
#       name: homebrew-lotus
#       branch: master
#     ids:
#       - primary
#     install: |
#       bin.install "lotus"
#       bin.install "lotus-miner"
#       bin.install "lotus-worker"
#     test: |
#       system "#{bin}/lotus --version"
#       system "#{bin}/lotus-miner --version"
#       system "#{bin}/lotus-worker --version"
#     directory: Formula
#     homepage: "https://filecoin.io"
#     description: "A homebrew cask for installing filecoin-project/lotus on MacOS"
#     license: MIT
#     skip_upload: auto
#     dependencies:
#       - name: hwloc

# produced manually so we can include cid checksums
checksum:
  disable: true

snapshot:
  name_template: "{{ .Env.VERSION }}"
